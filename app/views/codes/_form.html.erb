<!--
 <%#= form_with(model: code, local: true) do |form| %>
   <%# if code.errors.any? %>
     <div id="error_explanation">
       <h2><%#= pluralize(code.errors.count, "error") %> prohibited this code from being saved:</h2>

       <ul>
       <%# code.errors.full_messages.each do |message| %>
         <li><%#= message %></li>
       <%# end %>
       </ul>
     </div>
   <%# end %>

   <div class="actions">
     <%#= form.submit %>
   </div>
 <%# end %>
 -->
<html>
    <head>
        <meta charset="UTF-8">
        <%#= javascript_include_tag('app.js') %>
        <title>簡易オンラインジャッジシステム</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ace.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ext-language_tools.js"></script>
    </head>
    <body>
        <h1>コードをDockerコンテナで実行!</h1>
        言語：
        <select id="language">
            <option value="ruby">Ruby</option>
            <option value="python">Python</option>
            <option value="c">C</option>
        </select>
        <br/>

        ソースコード：<br/>
        <div id="source_code" style="width: 70%; height: 200px; resize: vertical;"></div>

        標準入力：<br/>
        <textarea id="input" style="width: 100%; height: 50px; resize: vertical;"></textarea>
        <br/>

        <button id="run_button" class="btn btn-primary">実行（Ctrl-Enter）</button>
        <br/>
        <hr/>

        標準出力：
        <pre><div id="stdout" style="background: lightgray"></div></pre>

        標準エラー出力：
        <pre><div id="stderr" style="background: lightgray"></div></pre>

        実行時間：
        <div id="time" style="background: lightgray"></div>

        終了コード：
        <div id="exit_code" style="background: lightgray"></div>
    </body>
</html>


<!--run.js-->
<script>
    // Submit and run the ConvolverNode.
function runCode(){
    $("#run_button").text("実行中...").prop("disabled", true);
    var language = $("#language").val();
    var source_code = aceEditor.getValue();
    var input = $("#input").val();
    $.ajax({
        url: "http://api.paiza.io/runners/create",
        method: "POST",
        data: {
            language: language,
            source_code: source_code,
            input: input,
            longpoll: false,
            api_key: 'guest'
        },
    }).done(function(result){
        var sessionId = result.id;
        var retryCount = 0;
        var getResult = function(){
            console.log("getResult");
            $.ajax({
                url: "http://api.paiza.io/runners/get_details?api_key=guest&id=" + sessionId,
                method: "GET",
            }).done(function(result){
                if(result.status == "running" && retryCount++ < 10){
                    setTimeout(getResult, 1000);
                    return;
                }
                console.log("result:", result);
                $("#stdout").text(result.stdout);
                $("#stderr").text(result, stderr);
                $("#time").text(result.time);
                $("#exit_code").text(result.exit_code);
                $("#run_button").text("実行（Ctrl-Enter）").prop("disabled", false);
            }).fail(function(error){
                alert("Request Failed:" + error);
                $("#run_button").text("実行（Ctrl-Enter）").prop("disabled", false);
            });
        };
        getResult();
    }).fail(function(error){
        alert("Request Failed:" + error);
        $("#run_button").text("実行（Ctrl-Enter）").prop("disabled", false);
    });
}
</script>